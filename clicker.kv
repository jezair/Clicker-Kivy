#:import from_hex kivy.utils.get_color_from_hex
#:import to_rgba kivy.utils.rgba
#:import colormap kivy.utils.colormap
#:import TimeManager main.TimeManager
#:import sin math.sin

#:set main_color '#1E88E5'
#:set main_color_dark "#0D47A1"
#:set accent_color '#26C6DA'
#:set bg_color_dark '#001528'
#:set bg_color_light '#00334F'
#:set accent_color_neon '#64FFDA'
#:set text_color '#E3F2FD'
#:set pastel_blue '#4FC3F7'
#:set pastel_pink '#FFB6C1'
#:set pastel_green '#81C784'

<Widget>:
    font_name: 'assets/Minecraft.ttf'


<ButtonMenu@Button>:

    font_size: "56sp"
    bold: True
    background_color: 0, 0, 0, 0

    size_hint: None, None
    pos_hint: {"center_x": 0.5}
    width: self.texture_size[0] + dp(60)
    color: from_hex(text_color)

    canvas.before:
        # Gray outer glow
        Color:
            rgba: from_hex(main_color_dark) + [0.6]
        RoundedRectangle:
            size: self.size[0] + dp(20), self.size[1] + dp(20)
            pos: self.pos[0] - dp(10), self.pos[1] - dp(10)
            radius: [dp(35)]
        # Secondary glow
        Color:
            rgba: from_hex(accent_color_neon) + [0.35]
        RoundedRectangle:
            size: self.size[0] + dp(16), self.size[1] + dp(16)
            pos: self.pos[0] - dp(8), self.pos[1] - dp(8)
            radius: [dp(30)]
        # Light shadow
        Color:
            rgba: 0, 0, 0, 0.18
        RoundedRectangle:
            size: self.size[0] + dp(8), self.size[1] + dp(8)
            pos: self.pos[0] - dp(4), self.pos[1] - dp(4)
            radius: [dp(25)]
        # Main button background - uses main palette, darker when pressed
        Color:
            rgba: from_hex(main_color_dark) if self.state == 'down' else from_hex(main_color)
        RoundedRectangle:
            size: self.size
            pos: self.pos
            radius: [dp(25)]
        # Inner highlight / pressed effect
        Color:
            rgba: from_hex(accent_color) + [0.18] if self.state == 'normal' else from_hex(accent_color_neon) + [0.35]
        RoundedRectangle:
            size: self.size[0] - dp(8), self.size[1] - dp(8)
            pos: self.pos[0] + dp(4), self.pos[1] + dp(4)
            radius: [dp(20)]


<ButtonIcon@ButtonMenu>:

    font_name: 'assets/typicons.ttf'
    font_size: "38sp"
    width: dp(80)

    height: dp(80)
    color: from_hex(text_color)
    
    canvas.before:
        # Gray outer glow (icons)
        Color:
            rgba: from_hex(main_color_dark) + [0.6]
        RoundedRectangle:
            size: self.size[0] + dp(20), self.size[1] + dp(20)
            pos: self.pos[0] - dp(10), self.pos[1] - dp(10)
            radius: [dp(35)]
        # Secondary glow
        Color:
            rgba: from_hex(accent_color_neon) + [0.35]
        RoundedRectangle:
            size: self.size[0] + dp(16), self.size[1] + dp(16)
            pos: self.pos[0] - dp(8), self.pos[1] - dp(8)
            radius: [dp(30)]
        # Light shadow
        Color:
            rgba: 0, 0, 0, 0.18
        RoundedRectangle:
            size: self.size[0] + dp(8), self.size[1] + dp(8)
            pos: self.pos[0] - dp(4), self.pos[1] - dp(4)
            radius: [dp(25)]
        # Main button background - uses main palette, darker when pressed
        Color:
            rgba: from_hex(main_color_dark) if self.state == 'down' else from_hex(main_color)
        RoundedRectangle:
            size: self.size
            pos: self.pos
            radius: [dp(25)]
        # Inner highlight / pressed effect
        Color:
            rgba: from_hex(accent_color) + [0.18] if self.state == 'normal' else from_hex(accent_color_neon) + [0.35]
        RoundedRectangle:
            size: self.size[0] - dp(8), self.size[1] - dp(8)
            pos: self.pos[0] + dp(4), self.pos[1] + dp(4)
            radius: [dp(20)]


<Menu>:
    BoxLayout:
        orientation: "vertical"
        padding: "30dp"
        spacing: "20dp"

        canvas:
            # Gradient background (disabled coloring)
            Color:
                rgba: 0, 0, 0, 0
            Rectangle:
                size: self.size
                pos: self.pos
            Color:
                rgba: 0, 0, 0, 0
            Rectangle:
                size: self.size[0], self.size[1] * 0.6
                pos: self.pos
            # Original background image without extra tint
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                source: 'assets/back_ground.jpeg'
                size: self.size
                pos: self.pos

        Widget:
            size_hint_y: 0.08

        Label:
            text: "UNDERWATER\nCLICKER"
            font_size: "54sp"
            halign: "center"
            size_hint_y: 0.25
            color: from_hex(text_color)
            canvas.before:
                # Blur background
                Color:
                    rgba: 0, 0, 0, 0.6
                RoundedRectangle:
                    size: self.size[0] + dp(40), self.size[1] + dp(40)
                    pos: self.pos[0] - dp(20), self.pos[1] - dp(20)
                    radius: [dp(20)]
                # Additional blur layers
                Color:
                    rgba: 0.1, 0.1, 0.3, 0.4
                RoundedRectangle:
                    size: self.size[0] + dp(30), self.size[1] + dp(30)
                    pos: self.pos[0] - dp(15), self.pos[1] - dp(15)
                    radius: [dp(18)]
                Color:
                    rgba: 0.2, 0.2, 0.4, 0.3
                RoundedRectangle:
                    size: self.size[0] + dp(20), self.size[1] + dp(20)
                    pos: self.pos[0] - dp(10), self.pos[1] - dp(10)
                    radius: [dp(15)]

        BoxLayout:
            orientation: "vertical"
            size_hint_y: 0.7
            
            Image:
                id: title_image
                source: "assets/images/title.png"
                allow_stretch: False
                keep_ratio: True
                size_hint_y: None
                height: dp(600)
                pos_hint: {"center_x": 0.5, "center_y": 5}
            
            ButtonIcon:
                text: " PLAY "
                size_hint_y: None
                height: dp(120)
                pos_hint: {"center_x": 0.5, "center_y": 0.6}
                color: from_hex(text_color)
                font_name: 'assets/Minecraft.ttf'
                font_size: "56sp"
                width: self.texture_size[0] + dp(60)
                on_press:
                    root.go_game()
            
            Widget:
                size_hint_y: 0.1

        Widget:
            size_hint_y: 0.1

        BoxLayout:
            size_hint_y: 0.15

            # Button "Settings"
            ButtonIcon:
                text: "\uE04F"
                on_press:
                    root.go_settings()

            Widget:

            # Button "Exit"
            ButtonIcon:
                text: "\uE121"
                on_press:
                    ConfirmExitPopup().open()


<ConfirmExitPopup>:
    size_hint: 0.6, 0.35
    auto_dismiss: False
    title: ''
    background_color: 0, 0, 0, 0.7

    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(20)

        Label:
            text: 'Exit the game?'
            font_size: '32sp'
            halign: 'center'
            valign: 'middle'
            color: from_hex(text_color)
            text_size: self.size

        BoxLayout:
            spacing: dp(20)

            ButtonMenu:
                text: 'Yes'
                on_press: app.stop()

            ButtonMenu:
                text: 'No'
                on_press: root.dismiss()


<Settings>:
    canvas.before:
        Color:
            rgba: from_hex(main_color)
        Rectangle:
            pos: self.pos
            size: self.size

    BoxLayout:
        orientation: 'vertical'
        spacing: dp(10)
        padding: dp(20)

        # Header
        Label:
            text: 'Settings'
            font_size: '32sp'
            color: text_color
            size_hint_y: None
            height: dp(60)

        # Particle Effects Toggle
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: dp(60)
            spacing: dp(20)

            Label:
                text: 'Particle Effects'
                font_size: '20sp'
                color: text_color
                size_hint_x: 0.6

            CheckBox:
                group: None
                active: True
                size_hint_x: 0.4
                on_active:
                    # play_sound('toggle')  # Future sound placeholder
                    pass

        # Volume Slider
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: dp(60)
            spacing: dp(20)

            Label:
                text: 'Volume'
                font_size: '20sp'
                color: text_color
                size_hint_x: 0.6

            Slider:
                id: volume_slider
                min: 0
                max: 100
                value: 100
                size_hint_x: 0.4
                on_value:
                    # Update global music volume
                    from main import bg_music
                    bg_music.set_volume(self.value / 100.0)

        # Spacer
        Widget:
            size_hint_y: 1

        # Back Button
        ButtonMenu:
            text: 'Back'
            size_hint_y: None
            height: dp(60)
            on_release:
                root.go_menu()
                # play_sound('back')  # Future sound placeholder


<RotatedImage>:
    canvas.before:
        PushMatrix
        Rotate:
            angle: self.angle
            axis: 0, 0, 1
            origin: self.center
    canvas.after:
        PopMatrix


<Fish>:
    source: 'assets/fish1.png'
    size_hint: None, None
    size: dp(200), dp(200)
    opacity: 0
    scale: 1.0
    color: 1, 1, 1, 1

    canvas.before:
        PushMatrix
        Scale:
            origin: self.center
            x: self.scale
        Rotate:
            angle: self.angle
            axis: 0, 0, 1
            origin: self.center
    canvas.after:
        PopMatrix


<Game>:
    # Main container with no padding or margins
    FloatLayout:
        # Background GIF - will cover entire screen
        Image:
            id: gif_background
            size_hint: None, None
            size: root.width, root.height
            pos: 0, 0
            allow_stretch: True
            keep_ratio: False
            canvas.before:
                Color:
                    rgba: 1, 1, 1, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
                    texture: self.texture

        # Main content container
        BoxLayout:
            orientation: "vertical"
            padding: 0
            spacing: 0
            size_hint: 1, 1

            # Верхнє меню
            BoxLayout:
                size_hint_y: 0.12
                padding: [0, 0, dp(20), 0]  # небольшой отступ справа для кнопки "Дом"

                Widget:
                    size_hint_x: None
                    width: dp(70)
                
                # Текстовий напис "Бали"
                Label:
                    text: str(root.score)
                    font_size: '56sp'
                    size_hint_x: 0.4
                    pos_hint: {'center_x': 0.9}
                    halign: 'center'
                    color: from_hex(text_color)

                # Кнопка-іконка "Дім"
                ButtonIcon:
                    text: '\uE08A'
                    width: dp(70)
                    height: dp(90)
                    color: from_hex(text_color)
                    canvas.before:
                        # Light shadow
                        Color:
                            rgba: 0, 0, 0, 0.18
                        RoundedRectangle:
                            size: self.size[0] + dp(8), self.size[1] + dp(8)
                            pos: self.pos[0] - dp(4), self.pos[1] - dp(4)
                            radius: [dp(20)]
                        # Gradient background - use main palette
                        Color:
                            rgba: from_hex(main_color_dark) if self.state == 'down' else from_hex(main_color)
                        RoundedRectangle:
                            size: self.size
                            pos: self.pos
                            radius: [dp(20)]
                        # Inner glow
                        Color:
                            rgba: from_hex(accent_color) + [0.22] if self.state == 'normal' else from_hex(accent_color_neon) + [0.35]
                        RoundedRectangle:
                            size: self.size[0] - dp(8), self.size[1] - dp(8)
                            pos: self.pos[0] + dp(4), self.pos[1] + dp(4)
                            radius: [dp(16)]
                    on_press: root.go_home()

            # Ігрова область
            FloatLayout:
                size_hint_y: 0.76
                id: game_window

                Fish:
                    id: fish
                    center: root.center

                Label:
                    id: level_complete
                    text: '    Level\ncomplete!'
                    color: from_hex('#00FF88')
                    font_size: '50sp'
                    size_hint_y: None
                    height: self.texture_size[1]
                    x: root.width / 2 - self.width / 2
                    y: root.height / 2 - self.height / 2 + dp(100)
                    opacity: 0
                    canvas.before:
                        # Blur background for level complete
                        Color:
                            rgba: 0, 0, 0, 0.4
                        RoundedRectangle:
                            size: self.size[0] + dp(40), self.size[1] + dp(40)
                            pos: self.pos[0] - dp(20), self.pos[1] - dp(20)
                            radius: [dp(20)]
                        Color:
                            rgba: 0.1, 0.3, 0.1, 0.3
                        RoundedRectangle:
                            size: self.size[0] + dp(30), self.size[1] + dp(30)
                            pos: self.pos[0] - dp(15), self.pos[1] - dp(15)
                            radius: [dp(18)]
                        Color:
                            rgba: 0.2, 0.4, 0.2, 0.2
                        RoundedRectangle:
                            size: self.size[0] + dp(20), self.size[1] + dp(20)
                            pos: self.pos[0] - dp(10), self.pos[1] - dp(10)
                            radius: [dp(15)]

            # Нижнє меню
            BoxLayout:
                size_hint_y: 0.12
                spacing: "20dp"
                padding: [dp(20), 0, 0, 0]  # небольшой отступ слева

                # Кнопка-іконка "Налаштування" слева (чуть выше)
                ButtonIcon:
                    font_name: 'assets/typicons.ttf'
                    text: '\uE04F'
                    size_hint_x: None
                    font_size: '38sp'
                    pos_hint: {'y': 0.05}
                    canvas.before:
                        # Light shadow
                        Color:
                            rgba: 0, 0, 0, 0.18
                        RoundedRectangle:
                            size: self.size[0] + dp(8), self.size[1] + dp(8)
                            pos: self.pos[0] - dp(4), self.pos[1] - dp(4)
                            radius: [dp(20)]
                        # Gradient background - use main palette
                        Color:
                            rgba: from_hex(main_color_dark) if self.state == 'down' else from_hex(main_color)
                        RoundedRectangle:
                            size: self.size
                            pos: self.pos
                            radius: [dp(20)]
                        # Inner glow
                        Color:
                            rgba: from_hex(accent_color) + [0.22] if self.state == 'normal' else from_hex(accent_color_neon) + [0.35]
                        RoundedRectangle:
                            size: self.size[0] - dp(8), self.size[1] - dp(8)
                            pos: self.pos[0] + dp(4), self.pos[1] + dp(4)
                            radius: [dp(16)]
                    on_press: root.go_settings()

                # Пустое пространство справа
                Widget: